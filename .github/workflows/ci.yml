name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (safe)
        run: |
          # Prefer specific Xcode if present, otherwise use the default
          if [ -d "/Applications/Xcode_15.2.app/Contents/Developer" ]; then
            sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
          elif [ -d "/Applications/Xcode.app/Contents/Developer" ]; then
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
          echo "xcode-select -> $(xcode-select -p)"
          xcodebuild -version

      - name: Install tooling (homebrew)
        run: |
          brew update || true
          brew install swiftlint swiftformat || true
        shell: bash

      - name: Build (xcodebuild)
        run: |
          # Adjust to workspace & scheme if needed
          if [ -f "*.xcworkspace" ]; then
            echo "Workspace detected; adjust build command as needed"
          fi
          # Try building using swift build first if SwiftPM; otherwise xcodebuild
          if [ -f "Package.swift" ]; then
            swift build --configuration debug
          else
            # Replace PROJECT_NAME and SCHEME below if you need explicit values
            xcodebuild -quiet -scheme "$SCHEME" -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 14' build || xcodebuild -quiet build
          fi
        env:
          SCHEME: ${{ env.SCHEME }}

      - name: Run tests
        run: |
          if [ -f "Package.swift" ]; then
            swift test --parallel
          else
            xcodebuild test -scheme "$SCHEME" -destination 'platform=iOS Simulator,name=iPhone 14' || true
          fi
        env:
          SCHEME: ${{ env.SCHEME }}

      - name: SwiftFormat (lint)
        run: |
          if command -v swiftformat >/dev/null 2>&1; then
            swiftformat --lint . || true
          fi

      - name: SwiftLint
        run: |
          if command -v swiftlint >/dev/null 2>&1; then
            swiftlint lint --strict || true
          fi
